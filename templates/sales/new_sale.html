<!-- templates/sales/new_sale.html -->
{% extends 'base.html' %} 
{% load static %}
{% block title %}Point of Sale - POS{% endblock %} 
{%block page_title %}Point of Sale{% endblock %} {% block extra_css %}
<style>
  .product-card {
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
  }

  .product-card:hover {
    transform: translateY(-5px);
    border-color: #0d6efd;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .product-card img {
    height: 120px;
    object-fit: cover;
  }

  .cart-item {
    border-bottom: 1px solid #dee2e6;
    padding: 10px 0;
  }

  .cart-total {
    font-size: 2rem;
    font-weight: bold;
    color: #198754;
  }

  .scanner-box {
    border: 2px dashed #6c757d;
    padding: 30px;
    text-align: center;
    border-radius: 10px;
    background-color: #f8f9fa;
  }

  .quantity-control {
    display: inline-flex;
    align-items: center;
  }

  .quantity-control button {
    width: 30px;
    height: 30px;
    padding: 0;
  }

  .quantity-control input {
    width: 60px;
    text-align: center;
    border-left: none;
    border-right: none;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Left Side - Product Selection -->
    <div class="col-lg-8">
      <!-- Search and Scanner -->
      <div class="card card-custom mb-3">
        <div class="card-body">
          <div class="row">
            <div class="col-md-8 mb-3 mb-md-0">
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input
                  type="text"
                  class="form-control form-control-lg"
                  id="productSearch"
                  placeholder="Search by name, SKU, or barcode..."
                />
              </div>
              <div
                id="searchResults"
                class="list-group mt-2"
                style="display: none"
              ></div>
            </div>
            <div class="col-md-4">
              <button
                class="btn btn-outline-primary btn-lg w-100"
                id="scanBarcodeBtn"
              >
                <i class="bi bi-upc-scan"></i> Scan Barcode
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Filter -->
      <div class="mb-3">
        <button
          class="btn btn-outline-secondary btn-sm me-2 category-filter active"
          data-category="all"
        >
          All Products
        </button>
        {% for category in categories %}
        <button
          class="btn btn-outline-secondary btn-sm me-2 category-filter"
          data-category="{{ category.name }}"
        >
          {{ category.name }}
        </button>
        {% endfor %}
      </div>

      <!-- Products Grid -->
      <div class="row" id="productsGrid">
        {% for product in products %}
        <div
          class="col-lg-3 col-md-4 col-sm-6 mb-3 product-item"
          data-category="{{ product.category.name}}"
        >
          <div
            class="card product-card"
            onclick="addToCart({{ product.id }}, '{{ product.name }}', {{ product.selling_price }}, {{ product.current_stock }})"
          >
            <img
              src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'img/bread.png' %}{% endif %}"
              class="card-img-top"
              alt="{{ product.name }}"
            />
            <div class="card-body p-2">
              <h6 class="card-title mb-1">{{ product.name }}</h6>
              <p class="card-text mb-1">
                <strong class="text-success"
                  >KES {{ product.selling_price }}</strong
                >
              </p>
              <small class="text-muted">
                Stock:
                <span
                  class="{% if product.is_low_stock %}text-danger{% endif %}"
                >
                  {{ product.current_stock }}
                </span>
              </small>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="alert alert-info">
            No products available.
            <a href="{% url 'products:product_create' %}">Add products</a> to
            start selling.
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right Side - Cart -->
    <div class="col-lg-4">
      <div class="card card-custom sticky-top" style="top: 100px">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-cart3"></i> Shopping Cart</h5>
        </div>
        <div class="card-body">
          <!-- Cart Items -->
          <div id="cartItems" style="max-height: 400px; overflow-y: auto">
            <div class="text-center text-muted py-5" id="emptyCart">
              <i class="bi bi-cart-x fs-1"></i>
              <p>Cart is empty</p>
            </div>
          </div>

          <!-- Cart Summary -->
          <div class="mt-3 pt-3 border-top">
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <strong id="subtotal">KES 0.00</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Tax (0%):</span>
              <strong id="tax">KES 0.00</strong>
            </div>
            <div class="d-flex justify-content-between mb-3">
              <h5>Total:</h5>
              <h5 class="cart-total" id="total">KES 0.00</h5>
            </div>

            <!-- Customer Details -->
            <div class="mb-3">
              <input
                type="text"
                class="form-control mb-2"
                id="customerName"
                placeholder="Customer Name (Optional)"
              />
              <input
                type="tel"
                class="form-control"
                id="customerPhone"
                placeholder="Customer Phone (for M-Pesa)"
              />
            </div>

            <!-- Payment Method -->
            <div class="btn-group w-100 mb-3" role="group">
              <input
                type="radio"
                class="btn-check"
                name="paymentMethod"
                id="cashPayment"
                value="CASH"
                checked
              />
              <label class="btn btn-outline-secondary" for="cashPayment">
                <i class="bi bi-cash"></i> Cash
              </label>

              <input
                type="radio"
                class="btn-check"
                name="paymentMethod"
                id="mpesaPayment"
                value="MPESA"
              />
              <label class="btn btn-outline-success" for="mpesaPayment">
                <i class="bi bi-phone"></i> M-Pesa
              </label>

              <input
                type="radio"
                class="btn-check"
                name="paymentMethod"
                id="cardPayment"
                value="CARD"
              />
              <label class="btn btn-outline-info" for="cardPayment">
                <i class="bi bi-credit-card"></i> Card
              </label>
            </div>

            <!-- Action Buttons -->
            <button
              class="btn btn-success btn-lg w-100 mb-2"
              id="completeBtn"
              disabled
            >
              <i class="bi bi-check-circle"></i> Complete Sale
            </button>
            <button class="btn btn-outline-danger w-100" id="clearBtn">
              <i class="bi bi-x-circle"></i> Clear Cart
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="modal fade" id="scannerModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Scan Barcode</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="scanner-box">
          <i class="bi bi-upc-scan fs-1 text-primary mb-3"></i>
          <h5>Enter Barcode</h5>
          <input
            type="text"
            class="form-control form-control-lg text-center mt-3"
            id="barcodeInput"
            placeholder="Scan or type barcode"
          />
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Payment Processing Modal -->
<div
  class="modal fade"
  id="paymentModal"
  tabindex="-1"
  data-bs-backdrop="static"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-5">
        <div
          class="spinner-border text-success mb-3"
          role="status"
          style="width: 3rem; height: 3rem"
        >
          <span class="visually-hidden">Processing...</span>
        </div>
        <h5>Processing Payment...</h5>
        <p class="text-muted" id="paymentMessage">Please wait</p>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  let cart = [];
  let cartTotal = 0;

  // Add to cart
  function addToCart(productId, productName, price, stock) {
    const existingItem = cart.find((item) => item.id === productId);

    if (existingItem) {
      if (existingItem.quantity < stock) {
        existingItem.quantity++;
        existingItem.subtotal = existingItem.quantity * price;
      } else {
        alert("Insufficient stock!");
        return;
      }
    } else {
      if (stock > 0) {
        cart.push({
          id: productId,
          name: productName,
          price: price,
          quantity: 1,
          subtotal: price,
          maxStock: stock,
        });
      } else {
        alert("Product out of stock!");
        return;
      }
    }

    updateCart();
  }

  // Update cart display
  function updateCart() {
    const cartItemsDiv = $("#cartItems");
    const emptyCart = $("#emptyCart");

    if (cart.length === 0) {
      emptyCart.show();
      $("#completeBtn").prop("disabled", true);
      cartTotal = 0;
    } else {
      emptyCart.hide();
      $("#completeBtn").prop("disabled", false);

      let html = "";
      cartTotal = 0;

      cart.forEach((item, index) => {
        cartTotal += item.subtotal;
        html += `
                    <div class="cart-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <strong>${item.name}</strong><br>
                                <small class="text-muted">KES ${item.price.toFixed(
                                  2
                                )} each</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="quantity-control">
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input type="number" class="form-control form-control-sm" 
                                       value="${item.quantity}" min="1" max="${
          item.maxStock
        }" 
                                       onchange="setQuantity(${index}, this.value)">
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <strong>KES ${item.subtotal.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
      });

      cartItemsDiv.html(html);
    }

    $("#subtotal").text("KES " + cartTotal.toFixed(2));
    $("#total").text("KES " + cartTotal.toFixed(2));
  }

  // Update quantity
  function updateQuantity(index, change) {
    const item = cart[index];
    const newQty = item.quantity + change;

    if (newQty > 0 && newQty <= item.maxStock) {
      item.quantity = newQty;
      item.subtotal = item.quantity * item.price;
      updateCart();
    } else if (newQty > item.maxStock) {
      alert("Insufficient stock!");
    }
  }

  // Set quantity directly
  function setQuantity(index, value) {
    const item = cart[index];
    const newQty = parseInt(value) || 1;

    if (newQty > 0 && newQty <= item.maxStock) {
      item.quantity = newQty;
      item.subtotal = item.quantity * item.price;
      updateCart();
    } else {
      alert("Invalid quantity or insufficient stock!");
      updateCart();
    }
  }

  // Remove from cart
  function removeFromCart(index) {
    cart.splice(index, 1);
    updateCart();
  }

  // Clear cart
  $("#clearBtn").click(function () {
    if (confirm("Clear entire cart?")) {
      cart = [];
      updateCart();
    }
  });

  // Complete sale
  $("#completeBtn").click(function () {
    if (cart.length === 0) return;

    const paymentMethod = $('input[name="paymentMethod"]:checked').val();
    const customerName = $("#customerName").val();
    const customerPhone = $("#customerPhone").val();

    if (paymentMethod === "MPESA" && !customerPhone) {
      alert("Please enter customer phone number for M-Pesa payment");
      return;
    }

    const saleData = {
      items: cart.map((item) => ({
        product_id: item.id,
        quantity: item.quantity,
      })),
      payment_method: paymentMethod,
      customer_name: customerName,
      customer_phone: customerPhone,
    };

    // Show payment modal
    $("#paymentModal").modal("show");
    $("#paymentMessage").text(
      "Processing your " + paymentMethod + " payment..."
    );

    // Submit sale
    $.ajax({
      url: '{% url "sales:new_sale" %}',
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify(saleData),
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      },
      success: function (response) {
        if (response.success) {
          if (paymentMethod === "MPESA") {
            $("#paymentMessage").text(
              "Payment request sent! Check phone to complete..."
            );

            // Poll for payment status
            checkPaymentStatus(response.checkout_request_id);
          } else {
            $("#paymentModal").modal("hide");
            alert(
              "Sale completed successfully!\nSale Number: " +
                response.sale_number
            );

            // Reset
            cart = [];
            updateCart();
            $("#customerName").val("");
            $("#customerPhone").val("");

            // Optionally redirect to receipt
            // window.location.href = '/sales/' + response.sale_id + '/';
          }
        }
      },
      error: function (xhr) {
        $("#paymentModal").modal("hide");
        alert(
          "Error: " + (xhr.responseJSON?.error || "Failed to complete sale")
        );
      },
    });
  });

  // Check M-Pesa payment status
  function checkPaymentStatus(checkoutRequestId) {
    let attempts = 0;
    const maxAttempts = 30;

    const interval = setInterval(function () {
      attempts++;

      $.get(
        "/api/payments/check-status/" + checkoutRequestId + "/",
        function (data) {
          if (data.status === "SUCCESS") {
            clearInterval(interval);
            $("#paymentModal").modal("hide");
            alert("Payment successful!\nM-Pesa Receipt: " + data.mpesa_receipt);

            // Reset cart
            cart = [];
            updateCart();
            $("#customerName").val("");
            $("#customerPhone").val("");
          } else if (data.status === "FAILED") {
            clearInterval(interval);
            $("#paymentModal").modal("hide");
            alert("Payment failed: " + data.result_desc);
          }
        }
      );

      if (attempts >= maxAttempts) {
        clearInterval(interval);
        $("#paymentModal").modal("hide");
        alert("Payment timeout. Please check transaction status manually.");
      }
    }, 2000);
  }

  // Product search
  let searchTimeout;
  $("#productSearch").on("input", function () {
    const query = $(this).val();
    const resultsDiv = $("#searchResults");

    clearTimeout(searchTimeout);

    if (query.length < 2) {
      resultsDiv.hide();
      return;
    }

    searchTimeout = setTimeout(function () {
      $.get('{% url "sales:search_product" %}?q=' + query, function (data) {
        if (data.products.length > 0) {
          let html = "";
          data.products.forEach(function (product) {
            html += `
                            <a href="#" class="list-group-item list-group-item-action" 
                               onclick="addToCart(${product.id}, '${product.name}', ${product.selling_price}, ${product.current_stock}); $('#searchResults').hide(); $('#productSearch').val(''); return false;">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>${product.name}</strong><br>
                                        <small class="text-muted">${product.sku}</small>
                                    </div>
                                    <div class="text-end">
                                        <strong class="text-success">KES ${product.selling_price}</strong><br>
                                        <small>Stock: ${product.current_stock}</small>
                                    </div>
                                </div>
                            </a>
                        `;
          });
          resultsDiv.html(html).show();
        } else {
          resultsDiv
            .html('<div class="list-group-item">No products found</div>')
            .show();
        }
      });
    }, 300);
  });

  // Category filter
  $(".category-filter").click(function () {
    $(".category-filter").removeClass("active");
    $(this).addClass("active");

    const category = $(this).data("category");

    if (category === "all") {
      $(".product-item").show();
    } else {
      $(".product-item").hide();
      $('.product-item[data-category="' + category + '"]').show();
    }
  });

  // Barcode scanner
  $("#scanBarcodeBtn").click(function () {
    $("#scannerModal").modal("show");
    setTimeout(function () {
      $("#barcodeInput").focus();
    }, 500);
  });

  $("#barcodeInput").on("keypress", function (e) {
    if (e.which === 13) {
      const barcode = $(this).val();

      $.get('{% url "sales:search_product" %}?q=' + barcode, function (data) {
        if (data.products.length > 0) {
          const product = data.products[0];
          addToCart(
            product.id,
            product.name,
            parseFloat(product.selling_price),
            product.current_stock
          );
          $("#scannerModal").modal("hide");
          $("#barcodeInput").val("");
        } else {
          alert("Product not found!");
        }
      });
    }
  });
</script>
{% endblock %}
